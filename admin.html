<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø´Ø±Ù</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { background-color: #f8f9fa; font-family: 'Tajawal', sans-serif; }
    .container { margin-top: 80px; max-width: 520px; }
    #status { margin-top: 14px; font-weight: 600; min-height: 1.4em; }
    pre { text-align: left; direction: ltr; background:#fff; border-radius:6px; padding:12px; box-shadow:0 1px 3px rgba(0,0,0,.06) }
  </style>
</head>
<body class="text-center">

  <div class="container">
    <h3 class="text-primary mb-2">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±Ù</h3>
    <p class="text-muted mb-4">Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Google Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ.</p>

    <!-- Ø¥Ø¹Ø¯Ø§Ø¯ GSI: Ø¶Ø¹ CLIENT_ID Ø§Ù„ØµØ­ÙŠØ­ Ø£Ø¯Ù†Ø§Ù‡ -->
    <div id="g_id_onload"
         data-client_id="YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_select="false">
    </div>
    <div class="g_id_signin" data-type="standard"></div>

    <p id="status" class="text-secondary">Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯.</p>

    <div id="debug" style="display:none">
      <h6 class="mt-3">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª (Debug)</h6>
      <pre id="userinfo">-</pre>
    </div>
  </div>

  <script>
    // Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· Ø³ÙƒØ±Ø¨Øª Google Apps Script Ø£Ùˆ Ø¨Ø§Ùƒ-Ø¥Ù†Ø¯ Ø§Ù„Ø°ÙŠ ÙŠØªØ­Ù‚Ù‚ Ù…Ù† id_token
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyd7OsvKLT0UQGJWZw_hjrTZydRmK19FZkTQ60lsQnXxv_VXMHOQMSYVO_lNhbAxVcGVQ/exec"; // ØºÙŠØ±Ù‡
    const CLIENT_ID = "1045715620879-4autgqus71bv0501bevcc08gs8s5bodn.apps.googleusercontent.com"; // ØºÙŠØ±Ù‡

    // ÙÙƒ JWT Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù„Ù€ debug ÙÙ‚Ø· (Ù„Ø§ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„ÙŠÙ‡ Ù„Ù„Ø£Ù…Ø§Ù†)
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1] || '';
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
          '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) {
        return null;
      }
    }

    async function handleCredentialResponse(response) {
      const statusEl = document.getElementById('status');
      statusEl.className = 'text-secondary';
      if (!response || !response.credential) {
        statusEl.innerText = "âš ï¸ Ù„Ù… Ù†Ø³ØªÙ„Ù… Ø±Ù…Ø² Ø§Ù„ØªØ¹Ø±ÙŠÙ (ID token).";
        return;
      }

      // decode for UI (only)
      const payload = parseJwt(response.credential);
      if (!payload) {
        statusEl.innerText = "âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù€ ID token Ù…Ø­Ù„ÙŠÙ‹Ø§.";
        return;
      }

      // Ø¹Ø±Ø¶ Ù…Ø¤Ù‚Øª
      statusEl.innerText = `ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ${payload.email || 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'}...`;

      // Ø§Ø±Ø³Ø§Ù„ id_token Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø¹Ø¨Ø± POST (Ø¢Ù…Ù† Ø£ÙƒØ«Ø± Ù…Ù† ÙˆØ¶Ø¹Ù‡ ÙÙŠ query string)
      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            id_token: response.credential
          }),
          // credentials: 'include' // ÙÙ‚Ø· Ø¥Ù† Ø§Ø­ØªØ¬Øª Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆÙƒÙŠØ²
        });

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© JSON
        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch(e) {
          throw new Error('Ø±Ø¯ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„ÙŠØ³ JSON ØµØ§Ù„Ø­: ' + text);
        }

        console.log('Server response:', json);

        if (res.ok && json && json.allowed === true) {
          statusEl.className = 'text-success';
          statusEl.innerText = 'âœ… Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ â€” Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­ÙˆÙŠÙ„...';
          // Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ø®Ø²Ù‘Ù† Ø¨Ø¹Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ sessionStorage
          // sessionStorage.setItem('user', JSON.stringify(json.user || payload));
          setTimeout(() => { window.location.href = 'dashboard.html'; }, 800);
        } else {
          statusEl.className = 'text-danger';
          statusEl.innerText = 'ğŸš« ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„';
          // Ø¥Ø¸Ù‡Ø§Ø± Ø³Ø¨Ø¨ Ø±ÙØ¶ Ø¥Ù† ÙˆÙØ¬Ø¯
          if (json && json.reason) {
            const r = document.createElement('div');
            r.className = 'small text-muted mt-2';
            r.innerText = json.reason;
            document.querySelector('.container').appendChild(r);
          }
          setTimeout(() => { window.location.href = 'noaccess.html'; }, 1300);
        }

        // debug
        document.getElementById('debug').style.display = 'block';
        document.getElementById('userinfo').innerText = JSON.stringify({
          token_payload: payload,
          server: json
        }, null, 2);

      } catch (err) {
        console.error('Fetch/Error:', err);
        statusEl.className = 'text-warning';
        statusEl.innerText = 'âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù„Ø±Ø¯: ' + (err.message || err);
      }
    }
  </script>
</body>
</html>

